# 🎉 AI 測試連線成功 - 下一步行動指南

> **狀態**：✅ OpenAI API 連線測試成功  
> **日期**：2024-12-23  
> **目標**：完成 AI 設定儲存並測試實際對話功能

---

## ✅ 已完成項目

| 項目 | 狀態 | 說明 |
|------|------|------|
| Edge Function 部署 | ✅ 完成 | 已修正 3 個 OpenAI API 參數問題 |
| API Key 驗證 | ✅ 完成 | OpenAI API Key 有效且有額度 |
| 連線測試 | ✅ 完成 | 成功連線至 OpenAI GPT-4o |

---

## 🎯 立即行動：儲存 AI 設定

### 步驟 1：確認目前設定

在「設定」→「系統管理」→「AI 設定」頁面，確認以下資訊：

| 欄位 | 值 | 說明 |
|------|-----|------|
| **AI 供應商** | OpenAI | ✅ 已選擇 |
| **模型** | gpt-4o | ✅ 已選擇 |
| **API Key** | sk-... | ✅ 已填寫且測試成功 |
| **API Endpoint** | (空白或預設) | ✅ 使用預設值 |

### 步驟 2：儲存設定

1. **點擊「儲存設定」按鈕**
2. **等待儲存完成**（應該會看到成功訊息）
3. **確認啟用狀態**（AI 設定應該標記為「已啟用」）

### 預期結果

**✅ 成功訊息**：
```
✅ AI 設定已儲存
```

**頁面狀態更新**：
- 測試狀態顯示「✅ 測試成功」
- 最後測試時間顯示剛剛的時間
- 設定狀態顯示「已啟用」

---

## 📝 下一步：測試 AI 秘書對話功能

### 階段 1：進入對話介面

#### 方法 A：儀表板頁面

1. 前往「**儀表板**」
2. 找到「AI 專案秘書」區塊或輸入框
3. 應該會看到一個可以輸入訊息的對話框

#### 方法 B：收件匣頁面

1. 前往「**收件匣**」
2. 找到 AI 輸入區域
3. 輸入您的訊息

### 階段 2：測試基本對話

#### 測試案例 1：一般問候

**輸入**：
```
你好
```

**預期回應**：
- AI 應該友善地回應問候
- 不應該建立任何卡片
- Intent 應該被識別為 `chat`

---

#### 測試案例 2：建立任務

**輸入**：
```
明天下午 3 點要跟客戶開會討論新功能
```

**預期回應**：
- AI 回應確認訊息（例如：「✅ 已為你建立任務...」）
- Intent 被識別為 `create_task`
- 提取的資訊包含：
  - 標題：「跟客戶開會討論新功能」
  - 截止日期：明天
  - 時間：下午 3 點

**預期行為**：
- 系統應該顯示建議卡（Suggested Card）
- 建議卡包含解析後的任務資訊
- 您可以選擇「確認建立」或「修改」

---

#### 測試案例 3：標記待回覆

**輸入**：
```
等王經理確認預算才能繼續
```

**預期回應**：
- AI 回應確認訊息
- Intent 被識別為 `mark_pending`
- 提取的資訊包含：
  - 標題：「等王經理確認預算才能繼續」
  - 等待對象：王經理
  - 預期回應：確認預算

---

#### 測試案例 4：記錄決議

**輸入**：
```
決定採用 PostgreSQL 作為主資料庫
```

**預期回應**：
- AI 回應確認訊息
- Intent 被識別為 `record_decision`
- 提取的資訊包含：
  - 標題：「採用 PostgreSQL 作為主資料庫」
  - 類別：技術決策

---

#### 測試案例 5：需求變更

**輸入**：
```
客戶要求新增匯出 Excel 功能
```

**預期回應**：
- AI 回應確認訊息
- Intent 被識別為 `change_request`
- 提取的資訊包含：
  - 標題：「新增匯出 Excel 功能」
  - 變更類型：新增（add）

---

### 階段 3：檢查瀏覽器 Console

開啟瀏覽器開發者工具（F12），查看 Console 日誌。

#### ✅ 成功的日誌範例

```
🔍 讀取系統 AI 設定...
✅ AI 設定載入成功: openai / gpt-4o
🤖 使用者輸入: 明天下午 3 點要跟客戶開會討論新功能
📡 呼叫 Edge Function: https://xxx.supabase.co/functions/v1/make-server-4df51a95/ai/chat
🤖 Intent Classification Result: {
  intent: "create_task",
  confidence: 0.95,
  extracted_info: {
    title: "跟客戶開會討論新功能",
    due_date: "tomorrow",
    ...
  }
}
✅ AI 回應成功
```

#### ❌ 如果出現錯誤

查看錯誤訊息並根據以下表格排查：

| 錯誤訊息 | 可能原因 | 解決方法 |
|---------|---------|---------|
| `AI 設定未啟用` | 尚未儲存設定 | 前往 AI 設定頁面儲存 |
| `Supabase 連線資訊不完整` | 缺少連線設定 | 前往 Supabase 連線設定頁面 |
| `API Key 無效` | API Key 過期或撤銷 | 重新建立 API Key |
| `Failed to parse JSON` | AI 回應格式錯誤 | 查看 Edge Function Logs |
| `Rate limit exceeded` | API 呼叫頻率過高 | 等待 1 分鐘後重試 |

---

## 🧪 進階測試：信心度分級

AI 會根據意圖的信心度（Confidence）採取不同行為：

### 高信心度（≥ 0.8）- 自動執行

**測試案例**：
```
明天下午 3 點開會
```

**預期行為**：
- AI 直接確認並建議建立任務
- 不需要額外澄清
- 顯示「✅ 已為你建立任務...」

---

### 中信心度（0.5 - 0.8）- 需要確認

**測試案例**：
```
明天要處理那個事情
```

**預期行為**：
- AI 顯示澄清選項
- 提供主要選項和替代選項
- 等待使用者確認

---

### 低信心度（< 0.5）- 請求澄清

**測試案例**：
```
那個東西怎麼樣了
```

**預期行為**：
- AI 顯示多個意圖選項（建立任務、標記待回覆、一般對話）
- 使用者需要手動選擇意圖
- 選擇後才執行對應動作

---

## 📊 成功驗收標準

完成以上測試後，確認以下項目全部達成：

### 基礎功能

- [ ] ✅ AI 設定已儲存並啟用
- [ ] ✅ 可以輸入訊息並得到回應
- [ ] ✅ 瀏覽器 Console 無錯誤訊息
- [ ] ✅ AI 回應時間在 3-10 秒內

### 意圖識別

- [ ] ✅ 一般對話（chat）可以正確識別
- [ ] ✅ 建立任務（create_task）可以正確識別
- [ ] ✅ 標記待回覆（mark_pending）可以正確識別
- [ ] ✅ 記錄決議（record_decision）可以正確識別
- [ ] ✅ 需求變更（change_request）可以正確識別

### 資訊提取

- [ ] ✅ 可以提取任務標題
- [ ] ✅ 可以提取截止日期（明天、下週等）
- [ ] ✅ 可以提取負責人／等待對象
- [ ] ✅ 可以提取優先級
- [ ] ✅ 可以提取決議類別

### 使用者體驗

- [ ] ✅ 建議卡顯示正確
- [ ] ✅ 可以確認或修改建議
- [ ] ✅ AI 回應友善且專業
- [ ] ✅ 錯誤訊息清晰易懂

---

## 🐛 常見問題與排查

### 問題 1：AI 沒有回應

**可能原因**：
- AI 設定未儲存
- Edge Function 沒有正確部署
- API Key 無效

**排查步驟**：
1. 檢查 Console 是否有錯誤訊息
2. 確認 AI 設定頁面顯示「已啟用」
3. 前往 Supabase Dashboard 查看 Edge Function Logs

---

### 問題 2：AI 回應錯誤或不合理

**可能原因**：
- Prompt 設計需要調整
- 模型參數需要優化
- 測試訊息太模糊

**排查步驟**：
1. 查看 Console 的 `Intent Classification Result`
2. 檢查 `confidence` 值是否太低
3. 嘗試更明確的測試訊息

---

### 問題 3：Intent 識別錯誤

**可能原因**：
- Few-shot examples 不夠多
- System prompt 需要優化
- 使用者輸入與訓練範例差異太大

**解決方法**：
1. 收集錯誤案例
2. 新增到 Few-shot examples
3. 調整 System prompt 說明

---

### 問題 4：回應太慢

**可能原因**：
- 模型選擇（gpt-4 比 gpt-4o 慢）
- maxTokens 設定太高
- 網路延遲

**解決方法**：
1. 考慮切換到 gpt-4o（更快）
2. 降低 maxTokens（目前 1000）
3. 檢查網路連線

---

## 📈 效能優化建議

### 建議 1：使用更快的模型

- **gpt-4o**：速度快、成本低、效果好 ✅ **推薦**
- **gpt-4o-mini**：更便宜但準確度略低
- **gpt-4-turbo**：較舊但仍可用
- **gpt-4**：最慢且最貴，不建議用於即時對話

### 建議 2：調整 maxTokens

目前設定為 1000，可以根據實際需求調整：

- **簡單意圖識別**：300-500 tokens 足夠
- **複雜對話**：800-1000 tokens
- **長文本摘要**：1500-2000 tokens

### 建議 3：快取常用回應

對於常見的問候或簡單查詢，可以考慮：

1. 在前端快取常見回應
2. 只有複雜意圖才呼叫 API
3. 節省成本並提升速度

---

## 💰 成本估算

### OpenAI GPT-4o 定價（2024年）

| 項目 | 價格 |
|------|------|
| Input Tokens | $2.50 / 1M tokens |
| Output Tokens | $10.00 / 1M tokens |

### 單次對話成本估算

假設：
- Input：150 tokens（System Prompt + User Input）
- Output：200 tokens（Intent Classification Result）

**成本計算**：
```
Input:  150 / 1,000,000 * $2.50  = $0.000375
Output: 200 / 1,000,000 * $10.00 = $0.002000
總計：約 $0.0024（約 0.07 台幣）
```

### 每月成本估算（中度使用）

假設每天 50 次對話：
```
每日成本：50 * $0.0024 = $0.12（約 3.6 台幣）
每月成本：$0.12 * 30 = $3.60（約 108 台幣）
```

**結論**：成本非常低，適合原型開發與測試。

---

## 📚 相關文件

- [AI ChatGPT 串接完成報告](/docs/AI_ChatGPT_Integration_Complete.md)
- [OpenAI API 參數變更說明](/docs/OpenAI_API_Parameter_Change.md)
- [AI 設定安全性說明](/docs/AI_Settings_Security.md)
- [AI API 測試檢查清單](/docs/AI_API_Testing_Checklist.md)

---

## 🎯 完成後的下一步

當您成功完成以上所有測試後，可以開始：

### 短期目標

1. **完善 UI 介面**
   - 優化建議卡的顯示樣式
   - 新增載入動畫
   - 改進錯誤提示

2. **擴充意圖類型**
   - 新增「查詢專案狀態」意圖
   - 新增「生成報告」意圖
   - 新增「專案建議」意圖

3. **優化 Prompt**
   - 新增更多 Few-shot examples
   - 根據實際使用情況調整 System Prompt
   - 改進資訊提取的準確度

### 中期目標

1. **實作建議卡確認流程**
   - 使用者可以確認建議並實際建立資料
   - 使用者可以修改建議的內容
   - 使用者可以拒絕建議

2. **整合專案資料**
   - AI 可以查詢現有專案資料
   - AI 可以提供基於歷史資料的建議
   - AI 可以自動關聯相關任務

3. **新增對話歷史**
   - 儲存對話記錄
   - 支援多輪對話
   - 提供對話搜尋功能

### 長期目標

1. **多模型支援**
   - 新增 Anthropic Claude 支援
   - 新增 Google Gemini 支援
   - 支援本地模型（如 Ollama）

2. **智慧化功能**
   - 主動提醒（基於 AI 分析）
   - 自動生成週報
   - 專案風險預警

3. **團隊協作**
   - 多人對話
   - 權限控制
   - 協作建議

---

## ✅ 當前狀態總結

| 階段 | 狀態 | 完成度 |
|------|------|--------|
| 🔧 環境設定 | ✅ 完成 | 100% |
| 🔌 API 串接 | ✅ 完成 | 100% |
| 🧪 連線測試 | ✅ 完成 | 100% |
| 💾 設定儲存 | ⏳ 進行中 | 待完成 |
| 💬 對話測試 | ⏳ 待開始 | 0% |
| ✨ UI 完善 | ⏳ 待開始 | 0% |

---

**恭喜您完成 AI API 連線！現在請儲存設定並開始測試實際的對話功能！** 🎉

---

**文件版本**：v1.0  
**最後更新**：2024-12-23  
**更新者**：AI Assistant
