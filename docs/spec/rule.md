# 全域業務規則（Global Business Rules）

> **文件版號**：V1.0  
> **最後更新**：2024-12-21  
> **優先順序**：`guidelines/Product_Context.md` → **本文件 `rules.md`** → `docs/plan/[模組名稱].md` → 程式碼實作

---

## 文件說明

### 目的
本文件為跨模組的「業務邏輯硬規則」，用於避免規格分散、語意不一致、資料在不同頁面不同步。

### 原則
- **僅寫業務規則**：包含驗證、限制、權限等業務邏輯。
- **零程式碼**：不寫 SQL、API Endpoint、變數名稱、CSS Class。
- **全域一致性**：所有模組必須遵守本文件規則。

### 使用方式
1. **開發前**：確認本次需求是否涉及既有規則、是否會造成規則衝突。
2. **開發中**：實作時必須符合本文件定義的規則。
3. **開發後**：對照本文件逐條檢核，確認實作行為一致。
4. **規則變更**：若需求會改變既有規則，必須先更新本文件並與使用者確認，再進入實作。

---

## 1. 核心名詞與資料主體

### 1.1 主要主體

#### Project（專案）
- **定義**：一個客戶案或內部案的獨立空間。
- **規則**：任何資料必須隸屬某個 Project。

#### Project Work（專案工作／工作包）
- **定義**：專案層級的「交付/工作容器」。
- **範例**：某功能模組、某交付文件、某次會議等。
- **規則**：用於組織和歸類 Item。

#### Item（任務項目）
- **定義**：實際會被追蹤、指派、變更狀態的工作單位。
- **規則**：系統僅有一套 Item，透過不同視角（TAB/頁面）呈現。

#### Artifact（來源/證據）
- **定義**：貼上的文字、上傳檔案、截圖、連結、會議逐字稿等「原始輸入」。
- **用途**：用於 Citation 溯源。
- **規則**：內容不可修改，以維持證據鏈的可信度。

---

### 1.2 單一事實來源（Single Source of Truth）

#### 核心原則
- **Item 是所有「任務卡片」的唯一資料來源**。
- 「收件匣、任務清單、待確認、變更、決議、專案工作」都只能顯示同一批 Item 的不同篩選/分組結果。

#### 嚴格禁止
- ❌ 禁止建立「重複任務卡片」。
- ❌ 禁止在不同模組各自維護狀態（會造成不同步）。

#### 連動一致性
- 同一筆 Item 在任何視角修改（狀態/期限/負責人/內容），其他視角必須同步更新。

---

## 2. 任務類型（Type）與狀態（Status）

### 2.1 任務類型 Type（決定顯示在哪些 TAB）

#### 定義
- **Type 是「任務類型」，不是進度狀態**。

#### 可選值
- **一般（general）**
- **待確認（pending）**
- **變更（cr / Change Request）**
- **決議（decision）**

#### 規則
1. 任務在「專案工作」底下，必須能顯示/選擇其 Type（一般/待確認/變更/決議）。
2. Type 會決定任務是否同步出現在「待確認/變更/決議」TAB。

---

### 2.2 任務狀態 Status（統一全系統命名）

#### 定義
- **Status 只代表進度，不代表任務類型**。

#### 可選值
- **未開始**
- **進行中**
- **卡關**
- **待回覆**（用於需要外部回覆的情境）
- **已完成**

#### 規則
1. **全系統所有任務類型**（general/pending/cr/decision）都使用同一套狀態命名。
2. ❌ **禁止為 CR、Decision 另外創造一套專屬狀態名稱**（避免認知混亂）。

---

## 3. TAB／視角的呈現規則（連動規則）

### 3.1 TAB 依據

- **TAB 的篩選依據 = Type（不是 Status）**。
- ❌ **「待回覆」屬於 Status，不能拿來當作 Type 或 TAB 的判斷依據**。

---

### 3.2 必須存在的視角（概念）

#### 專案工作（Project Work）視角
- 以 Project Work 分組，展開查看其底下的 Items。

#### 任務清單（Task List）視角
- 以使用者角度/狀態/篩選查詢 Items。

#### 待確認 TAB
- 顯示 `Type = pending` 的 Items。

#### 變更 TAB
- 顯示 `Type = cr` 的 Items。

#### 決議 TAB
- 顯示 `Type = decision` 的 Items。

---

### 3.3 連動一致性（硬規則）

#### 規則 1：跨視角同步
同一筆 Item 在任何視角修改（狀態/期限/負責人/內容），其他視角必須同步更新。

#### 規則 2：Type 變更時的連動
在「專案工作」中將某 Item Type 設為 pending/cr/decision：
- ✅ 該 Item **必須自動出現**在對應 TAB（待確認/變更/決議）。

#### 規則 3：TAB 內操作的連動
在 TAB 中對 Item 的操作（改狀態、指派、改期限、補充內容）：
- ✅ 也必須同步反映回「專案工作」底下同一筆 Item。

---

## 4. 專案工作（Project Work）與歸屬規則

### 4.1 Item 歸屬到 Project Work

#### 規則
1. 每一筆 Item **可歸屬到**某個 Project Work。
2. ✅ **允許 Item 暫時不歸屬**（例如剛入庫、AI 不確定、使用者還沒整理）。

---

### 4.2 Item 層級關係（Hierarchy）

#### 定義
- Item 可以具有**父子關係**，用於表達任務之間的層級結構（例如 WBS 工作分解結構）。
- **parent_id**：指向父任務的 ID（null 表示根任務）。
- **level**：任務層級（1=根任務，2=第二層，依此類推），儲存於 `meta.level`。

#### 規則
1. ✅ **允許任務具有父子關係**：透過 `parent_id` 欄位建立。
2. ✅ **層級一致性**：子任務的 level 應等於父任務的 level + 1。
3. ✅ **WBS 編號**：若任務標題包含 WBS 編號（例如 "1.1 需求訪談"），系統會自動提取編號並儲存於 `meta.wbs_code`。
4. ✅ **建立順序**：從 WBS 文件建立任務時，父任務必須先建立，子任務後建立。

#### 使用情境
- **WBS 文件上傳**：當使用者上傳 WBS 圖片、Excel、PDF 時，AI 會自動識別層級結構並建立父子關聯。
- **任務拆解**：使用者可以手動將一個大任務拆解為多個子任務。
- **專案工作視圖**：在專案工作視圖中，可以用樹狀結構顯示任務層級。

---

### 4.3 未歸屬（未分類）

#### 規則 1：顯示位置
若 Item 尚未歸屬任何 Project Work：
- ✅ 必須顯示在**「未分類 / 未歸屬」群組**中。

#### 規則 2：已完成的 Item
- **若有歸屬**：仍留在原 Project Work 下並標示「已完成」。
- **若未歸屬**：留在「未分類」群組中並標示「已完成」。

---

### 4.4 Project Work 類型（MVP 固定）

#### 可選類型
因架構簡化，先避免過多類型。

- **功能模組**
- **交付文件**
- **會議**

#### 規則
1. ❌ **「外部依賴」不列為 Project Work 類型**（較少見且易膨脹範圍）。
2. 外部依賴/等待事項，以 **Item（任務）形式**在任務清單中管理即可。

#### 類型自訂
- **建議後續**以「專案設定」提供 PM 自訂（MVP 可先不做）。

---

## 5. 收件匣（Inbox）入庫規則

### 5.1 收件匣定位

- **收件匣是「AI 建議 → 人工確認 → 入庫」的緩衝區**。
- 任何來自貼上文字/上傳文件/截圖/連結等輸入，先形成 **Artifact**，再由 AI 生成建議卡（Suggestion）。

---

### 5.2 入庫與不入庫

#### 確認（Confirm）
- 建議卡轉為正式 **Item**，才會進入任務清單與專案工作連動。

#### 編輯後確認（Edit & Confirm）
- ✅ 允許在入庫前修正標題/摘要/負責人/期限/Type。

#### 拒絕（Reject）
- 不入庫，但仍需保留「來源 Artifact」存在（視專案策略可封存/標記）。

---

### 5.3 入庫後的歸屬

#### 規則 1：AI 推測歸屬
- 入庫時若 AI 能推測 Project Work 歸屬：**只能作為「建議」，仍需使用者確認**。

#### 規則 2：無法推測時
- 若無法推測：預設歸入**「未分類/未歸屬」**。

---

## 6. Citation／溯源與 Artifact 不可篡改

### 6.1 Citation 必備

#### 規則
1. 任何由 AI 生成、或被視為可追溯的 Item（待確認/變更/決議/重要待辦），應提供 **Citation 能力**。
2. Citation 必須能回到對應的 **Artifact**（來源文字/文件/截圖/連結）。

---

### 6.2 Artifact 不可修改

#### 原則
- ❌ **來源內容不可修改**，以維持證據鏈的可信度。

#### 允許的例外（MVP）
- ✅ 重新命名/補充來源說明（例如檔名、來源描述）。

#### 來源被移除時
若來源被封存或移除：
- Item 仍保留來源 ID。
- UI 必須提示**「來源已移除/封存」**。

---

## 7. 權限與角色（最小可行規則）

### 7.1 專案角色（參考用途）

#### 可選角色
- **Client（客戶）**
- **PM**
- **Designer（設計）**
- **Engineer（工程）**
- **Other（其他）**

#### 用途
角色主要用於：
- 預設篩選
- 指派建議
- 視覺標示

#### 備註
MVP 階段可先不做複雜權限矩陣。

---

### 7.2 誰可以改「任務狀態」

#### 規則
1. **PM**：可變更任何 Item 的狀態。
2. **任務負責人**：可變更自己負責的 Item 狀態。
3. **其他成員**：預設不可改狀態（可留言/補充資訊視需求開放）。

---

### 7.3 指派規則（Assignee）

#### MVP 建議
- **單一負責人**（責任清楚）。

#### 若後續需要多人協作
1. 可加入**「協作/抄送（watchers/collaborators）」**概念，不等同負責人。
2. 若要多負責人，必須同時具備：
   - **主要負責人**概念
   - 權限規則（避免互相覆蓋狀態）

---

## 8. 專案與設定（System vs Project）

### 8.1 系統設定（System Settings）

#### 定義
只屬於**「系統管理員」**的全系統設定。

#### 範例
- AI 供應商與模型設定（API Key、模型選擇）
- 系統層級的連線策略
- 全域維運選項等

#### 重要原則
- ❌ **API Key 等機密不得只存前端**。
- ✅ 正式連線時需儲存在後端資料庫/安全儲存（Supabase）。
- ✅ **AI 設定為全系統共用**，所有專案使用同一組 AI 供應商與模型。

---

### 8.2 AI 設定規則

#### 定義
- **AI 供應商與模型**：全系統唯一設定，所有專案共用。
- **使用情境**：AI 秘書對話、文件解析、晨間簡報生成。

#### 儲存規則
1. API Key 必須加密儲存於 Supabase。
2. 系統只能有一組啟用中的 AI 設定（`is_active = true`）。
3. 前端顯示 API Key 時必須遮罩（只顯示前後各 3 字元）。

#### 驗證規則
1. 供應商與模型必須配對正確（例如 OpenAI 供應商不能選擇 Claude 模型）。
2. API Key 格式驗證：
   - OpenAI：以 `sk-` 或 `sk-proj-` 開頭
   - Anthropic：以 `sk-ant-` 開頭
   - Google：符合 Google API Key 格式
3. 測試連線必須在儲存前執行（建議但非強制）。

---

### 8.3 專案設定（Project Settings）

#### 定義
屬於**「PM」**可管理的專案層級設定。

#### 範例
- 專案資訊
- 專案成員
- 專案工作類型（若開放自訂）
- 專案規則偏好等

---

## 9. 專案生命週期與資料處置

### 9.1 專案狀態

#### 啟用
- 可正常編輯與操作。

#### 封存
- 專案成員**不可編輯**（唯讀）。
- ✅ 可查詢/回顧。

#### 刪除
- 需二次確認。
- 採**「先標記刪除」策略**。

---

### 9.2 刪除延遲規則

#### 規則
1. **刪除時**：先標記為「待刪除」。
2. **一個月後**才正式刪除專案與相關資料。
3. **一個月內**允許**「復原」**。

---

## 10. 介面互動底線（避免系統看起來很複雜）

### 規則 1：任務卡片互動
- 任務卡片必須**可點擊開啟詳情**（例如右側抽屜）。
- 下拉選單只做**快速改狀態**。

### 規則 2：TAB 卡片內容
- TAB 卡片內容應以**「可決策、可行動」**為主。
- ❌ 避免只顯示數量卻佔很大面積。

### 規則 3：AI 區塊引導
- AI 區塊（例如收件匣/儀表板）必須有**明顯視覺差異與引導**。
- 提供：提示 chips / 範例語句 / 回饋狀態。
- 強化**「虛擬專案秘書」**感。

---

## 11. 驗收檢核（用來判斷有沒有違反規則）

開發完成後，必須逐項檢核以下項目：

### ✅ 檢核清單

1. **跨視角同步**  
   - [ ] 在任一視角改 Item 狀態/負責人/期限，其他視角立即同步（無分裂）。

2. **Type 與 TAB 連動**  
   - [ ] `Type = pending/cr/decision` 的 Item 必須出現在對應 TAB（同一筆資料）。

3. **Project Work 顯示 Type**  
   - [ ] Project Work 底下能看見 Item 的 Type badge（待確認/變更/決議），避免混淆。

4. **未歸屬處理**  
   - [ ] 未歸屬 Item 一律落在「未分類/未歸屬」。

5. **權限控制**  
   - [ ] PM 與負責人可改狀態；其他人預設不可改。

6. **Artifact 保護**  
   - [ ] Artifact 內容不可被修改。
   - [ ] 引用來源若被封存/移除需有明確提示。

7. **專案生命週期**  
   - [ ] 專案封存後不可編輯。
   - [ ] 刪除採延遲一個月、可復原。

---

## 附錄：文件維護紀錄

| 日期 | 版本 | 變更內容 | 變更原因 |
|------|------|----------|----------|
| 2024-12-21 | V1.0 | 初版建立 | 建立全域業務規則統一管理 |

---

## 相關文件

- `guidelines/Product_Context.md` - 系統核心背景與主詞定義
- `docs/plan/[模組名稱].md` - 各模組的具體規劃文件
- `guidelines/Guidelines.md` - 開發流程與架構規範

---

**END OF DOCUMENT**