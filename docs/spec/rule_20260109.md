# 全域業務規則（Global Business Rules）

> **文件版號**：V2.0  
> **建立日期**：2026-01-09  
> **優先順序**：`guidelines/Product_Context.md` → **本文件** → `docs/plan/[模組名稱].md` → 程式碼實作

---

## 文件說明

### 目的
本文件為跨模組的「業務邏輯硬規則」，用於避免規格分散、語意不一致、資料在不同頁面不同步。

### 原則
- **僅寫業務規則**：包含驗證、限制、權限等業務邏輯。
- **零程式碼**：不寫 SQL、API Endpoint、變數名稱、CSS Class。
- **全域一致性**：所有模組必須遵守本文件規則。

### 使用方式
1. **開發前**：確認本次需求是否涉及既有規則、是否會造成規則衝突。
2. **開發中**：實作時必須符合本文件定義的規則。
3. **開發後**：對照本文件逐條檢核，確認實作行為一致。
4. **規則變更**：若需求會改變既有規則，必須先更新本文件並與使用者確認，再進入實作。

---

## 1. 核心名詞與資料主體

### 1.1 主要主體

#### Project（專案）
- **定義**：一個客戶案或內部案的獨立空間。
- **規則**：任何資料必須隸屬某個 Project。

#### Item（任務項目）
- **定義**：實際會被追蹤、指派、變更狀態的工作單位。
- **規則**：
  - 系統僅有一套 Item，透過不同視角（TAB/頁面）呈現。
  - Item 透過 `meta` 欄位標記其類別屬性。

#### Artifact（來源/證據）
- **定義**：貼上的文字、上傳檔案、截圖、連結、會議逐字稿等「原始輸入」。
- **用途**：用於 Citation 溯源。
- **規則**：內容不可修改，以維持證據鏈的可信度。

---

### 1.2 任務類別（三大類別）

系統將任務分為三大類別，透過 `type` 欄位和 `meta` 屬性區分：

| 類別 | type 欄位 | meta 屬性 | 專屬欄位 |
|------|-----------|-----------|----------|
| **專案工作** | `general` | `isWorkPackage: true` | 無 |
| **功能模組** | `general` | `isFeatureModule: true` | 需求規格、功能規格(FRD)、設計雛形 |
| **待辦事項** | `todo` | 無 | 無 |

#### 類別轉換規則
- ✅ **允許互相轉換**：三種類別之間可以互相轉換。
- ⚠️ **功能模組限制**：若功能模組已填寫專屬欄位（需求規格、功能規格、設計雛形）任一欄位，則**禁止轉換**為其他類別。
- ✅ **轉換後導向**：轉換完成後，系統自動導向至對應的視圖頁面。

---

### 1.3 單一事實來源（Single Source of Truth）

#### 核心原則
- **Item 是所有「任務卡片」的唯一資料來源**。
- 「專案工作、功能模組、待辦事項」都只能顯示同一批 Item 的不同篩選/分組結果。

#### 嚴格禁止
- ❌ 禁止建立「重複任務卡片」。
- ❌ 禁止在不同模組各自維護狀態（會造成不同步）。

#### 連動一致性
- 同一筆 Item 在任何視角修改（狀態/期限/負責人/內容），其他視角必須同步更新。

---

## 2. 任務狀態（Status）

### 2.1 狀態定義

#### 定義
- **Status 只代表進度，不代表任務類型**。

#### 可選值

| 狀態值 | 顯示名稱 | 說明 |
|--------|----------|------|
| `not_started` | 未開始 | 任務尚未開始執行 |
| `in_progress` | 進行中 | 任務正在進行中 |
| `blocked` | 卡關 | 任務因障礙無法繼續 |
| `awaiting_response` | 待回覆 | 需要外部回覆才能繼續 |
| `on_hold` | 暫停 | 任務暫時擱置 |
| `completed` | 已完成 | 任務已完成 |
| `suggestion` | 建議中 | AI 建議尚未確認（收件匣專用） |
| `rejected` | 已拒絕 | AI 建議已被拒絕 |

#### 規則
1. **全系統所有任務類型**都使用同一套狀態命名。
2. ❌ **禁止為特定類別另外創造專屬狀態名稱**。
3. ✅ **向後相容**：舊狀態（如 `done`）會自動對應到新狀態（`completed`）。

---

## 3. 任務清單視圖規則

### 3.1 視圖 TAB 劃分

任務清單頁面包含以下 TAB：

| TAB | 篩選條件 | 說明 |
|-----|----------|------|
| **專案工作** | `meta.isWorkPackage = true` | 專案層級的工作項目 |
| **功能模組** | `meta.isFeatureModule = true` | 系統功能模組開發 |
| **待辦事項** | `type = 'todo'` | 一般待辦事項 |
| **待確認** | `type = 'pending'` | 需要確認的事項 |
| **變更請求** | `type = 'cr'` | 變更需求 |
| **決議** | `type = 'decision'` | 決議事項 |

### 3.2 TAB 徽章數量規則

各 TAB 顯示的數量徽章代表「進行中但尚未完成」的任務數：

- **計算公式**：該類別的任務總數 - 已完成任務數
- **已完成狀態**：`status = 'completed'`

---

### 3.3 層級結構（Hierarchy）

#### 定義
- Item 可以具有**父子關係**，用於表達任務之間的層級結構（例如 WBS 工作分解結構）。
- **parent_id**：指向父任務的 ID（null 表示根任務）。
- **level**：任務層級儲存於 `meta.level`。

#### 規則
1. ✅ **允許任務具有父子關係**：透過 `parent_id` 欄位建立。
2. ✅ **層級一致性**：子任務的 level 應等於父任務的 level + 1。
3. ✅ **WBS 編號**：若任務標題包含 WBS 編號，系統會自動提取編號並儲存於 `meta.wbs_code`。

---

## 4. 功能模組專屬規則

### 4.1 專屬欄位

功能模組具有以下專屬欄位（儲存於 `meta` 中）：

| 欄位 | meta 鍵名 | 說明 |
|------|-----------|------|
| **需求規格** | `requirementsSpec` | 功能的需求描述 |
| **功能規格 (FRD)** | `functionalSpec` | 功能規格文件內容 |
| **功能規格連結** | `functionalSpecLink` | 外部文件連結 |
| **設計雛形** | `designPrototypes` | 設計雛形陣列 |

### 4.2 設計雛形結構

```
{
  id: string;
  url?: string;        // Figma 等雛形網址
  imageUrl?: string;   // 圖片 URL 或 Base64
  description: string; // 說明
}
```

### 4.3 轉換限制

當功能模組具有以下任一條件時，**禁止轉換**為其他類別：
- `requirementsSpec` 有內容
- `functionalSpec` 有內容
- `designPrototypes` 陣列長度 > 0

**處理方式**：
- UI 顯示轉換按鈕為禁用狀態
- 提示文字：「(有欄位內容)」
- 點擊時顯示錯誤訊息：「此功能模組已有需求規格、功能規格或設計雛形，無法轉換。請先清除這些欄位內容。」

---

## 5. 收件匣（Inbox）規則

### 5.1 收件匣定位

- **收件匣是「AI 建議 → 人工確認 → 入庫」的緩衝區**。
- 任何來自貼上文字/上傳文件/截圖/連結等輸入，先形成 **Artifact**，再由 AI 生成建議卡（Suggestion）。

### 5.2 入庫與不入庫

#### 確認（Confirm）
- 建議卡轉為正式 **Item**，才會進入任務清單連動。

#### 編輯後確認（Edit & Confirm）
- ✅ 允許在入庫前修正標題/摘要/負責人/期限/Type。

#### 拒絕（Reject）
- 不入庫，但仍需保留「來源 Artifact」存在。

---

## 6. 來源文件（Sources）規則

### 6.1 Artifact 不可修改

#### 原則
- ❌ **來源內容不可修改**，以維持證據鏈的可信度。

#### 允許的例外
- ✅ 重新命名/補充來源說明。

### 6.2 刪除規則

- 刪除 Artifact 前必須**二次確認**。
- 刪除後，引用該來源的 Item 需顯示**「來源已移除」**提示。

---

## 7. 部署與配置規則

### 7.1 Supabase 連線配置

#### 優先順序
系統按以下優先順序讀取 Supabase 連線資訊：
1. **環境變數**（Vercel 部署）：`VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`
2. **localStorage**（本地開發/自訂）

#### 規則
- ✅ **環境變數優先**：當環境變數已設定時，使用者無需手動配置。
- ✅ **Setup Page**：僅在環境變數和 localStorage 都沒有設定時，才要求手動配置。

### 7.2 Schema 配置

- **Schema 名稱**：從 `localStorage('supabase_schema')` 讀取，預設為 `'aiproject'`。
- ❌ **禁止硬編碼**：程式碼中不得寫死 schema 名稱。

---

## 8. 刪除與依賴規則

### 8.1 任務刪除

#### 前置檢查
刪除任務前，系統必須檢查：
- 是否有子任務（被引用為 parent）
- 是否有相依任務（被引用為 dependency）

#### 處理方式
- **有依賴時**：先**解除依賴關係**，再執行刪除。
- **刪除對話框**：使用 `AlertDialog` 元件，禁止使用瀏覽器原生 `confirm()`。

### 8.2 專案刪除

- 需二次確認。
- 採**「先標記刪除」策略**，一個月後才正式刪除。
- 一個月內允許**「復原」**。

---

## 9. 權限規則

### 9.1 狀態變更權限

| 角色 | 權限 |
|------|------|
| **PM** | 可變更任何 Item 的狀態 |
| **任務負責人** | 可變更自己負責的 Item 狀態 |
| **其他成員** | 預設不可變更狀態 |

### 9.2 指派規則

- MVP 階段採用**單一負責人**制度。
- 一個任務只能有一個負責人（責任清楚）。

---

## 10. 介面互動規則

### 10.1 任務卡片互動

- 任務卡片必須**可點擊開啟詳情頁**。
- 更多選單提供快速操作（編輯、刪除、類別轉換）。

### 10.2 轉換類型選單

- 使用 **DropdownMenu** 呈現轉換選項。
- 只顯示可轉換的目標類別（排除當前類別）。
- 禁用狀態時顯示提示文字。

### 10.3 確認對話框

- 使用 **AlertDialog** 元件。
- ❌ 禁止使用 `window.confirm()` 或 `window.alert()`。

---

## 11. 驗收檢核清單

開發完成後，必須逐項檢核以下項目：

### ✅ 檢核清單

1. **跨視角同步**  
   - [ ] 在任一視角改 Item 狀態/負責人/期限，其他視角立即同步。

2. **類別轉換**  
   - [ ] 三種類別可互相轉換。
   - [ ] 功能模組有專屬欄位內容時，轉換按鈕禁用。

3. **功能模組欄位保護**  
   - [ ] 需求規格、功能規格、設計雛形任一有內容時禁止轉換。

4. **Supabase 配置**  
   - [ ] 環境變數優先於 localStorage。
   - [ ] Vercel 部署後使用者無需手動設定。

5. **刪除確認**  
   - [ ] 刪除操作使用 AlertDialog 二次確認。
   - [ ] 刪除時自動解除依賴關係。

6. **Artifact 保護**  
   - [ ] Artifact 內容不可被修改。
   - [ ] 引用來源若被移除需有明確提示。

---

## 附錄：文件維護紀錄

| 日期 | 版本 | 變更內容 |
|------|------|----------|
| 2024-12-21 | V1.0 | 初版建立 |
| 2026-01-09 | V2.0 | 重新整理並更新：新增三大類別定義、類別轉換規則、功能模組專屬欄位、Supabase 配置優先順序、刪除依賴規則 |

---

## 相關文件

- `guidelines/Product_Context.md` - 系統核心背景與主詞定義
- `docs/plan/[模組名稱].md` - 各模組的具體規劃文件
- `guidelines/Guidelines.md` - 開發流程與架構規範

---

**END OF DOCUMENT**
