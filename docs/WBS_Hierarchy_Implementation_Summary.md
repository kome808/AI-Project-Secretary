# WBS å±¤ç´šæ¶æ§‹è‡ªå‹•ç¹¼æ‰¿åŠŸèƒ½ - å¯¦ä½œæ‘˜è¦

> å®Œæˆæ—¥æœŸï¼š2024-12-26  
> å¯¦ä½œè€…ï¼šAI Assistant  
> éœ€æ±‚ä¾†æºï¼šä½¿ç”¨è€…éœ€æ±‚ - "åˆ†æwbsï¼Œè¦å¯ä»¥æ ¹æ“šåŸä¾†çš„å±¤ç´šæ¶æ§‹ï¼Œè®Šæˆä»»å‹™å¡ä¹Ÿæœ‰åŒæ¨£çš„å±¤ç´š"

## ğŸ¯ åŠŸèƒ½æ‘˜è¦

ç•¶ä½¿ç”¨è€…ä¸Šå‚³ WBS æ–‡ä»¶ï¼ˆåœ–ç‰‡ã€PDFã€Excelã€Wordï¼‰æ™‚ï¼Œç³»çµ±ç¾åœ¨èƒ½å¤ ï¼š

1. **è‡ªå‹•è­˜åˆ¥å±¤ç´š**ï¼šAI è‡ªå‹•è§£æä»»å‹™ä¹‹é–“çš„çˆ¶å­é—œä¿‚
2. **ä¿ç•™å±¤ç´šçµæ§‹**ï¼šå»ºç«‹ä»»å‹™æ™‚è‡ªå‹•è¨­å®š `parent_id` å’Œ `level`
3. **æ­£ç¢ºæ’åºå»ºç«‹**ï¼šç¢ºä¿çˆ¶ä»»å‹™å…ˆå»ºç«‹ï¼Œé¿å…é—œè¯éŒ¯èª¤
4. **æ¸›å°‘æ‰‹å‹•èª¿æ•´**ï¼šä½¿ç”¨è€…ç„¡éœ€å†æ‰‹å‹•è¨­å®šä»»å‹™å±¤ç´š

## ğŸ“ ä¸»è¦è®Šæ›´

### 1. è³‡æ–™çµæ§‹æ“´å……

**Item.meta æ–°å¢æ¬„ä½**ï¼š
```typescript
meta: {
  level?: number;           // ğŸ†• å±¤ç´šï¼ˆ1=æ ¹ä»»å‹™ï¼Œ2=ç¬¬äºŒå±¤ï¼‰
  wbs_code?: string;        // WBS ç·¨è™Ÿï¼ˆå·²å­˜åœ¨ï¼‰
  original_order?: number;  // ğŸ†• åŸå§‹æ’åº
  ...
}
```

**Item.parent_id**ï¼š
- å·²å­˜åœ¨çš„æ¬„ä½ï¼Œç¾åœ¨æœƒè¢«æ­£ç¢ºè¨­å®š

### 2. æ ¸å¿ƒé‚è¼¯æ”¹é€²

**æª”æ¡ˆä½ç½®**ï¼š`/src/app/dashboard/DashboardPage.tsx`

**é—œéµæ”¹é€²**ï¼š

#### A. ID æ˜ å°„è¡¨
```typescript
// AI çš„è‡¨æ™‚ ID -> å¯¦éš›è³‡æ–™åº« ID
const idMapping = new Map<string, string>();
```

#### B. æŒ‰å±¤ç´šæ’åº
```typescript
const sortedItems = [...items].sort((a, b) => {
  const levelA = a.meta?.level || 1;
  const levelB = b.meta?.level || 1;
  return levelA - levelB; // ç¢ºä¿çˆ¶ä»»å‹™å…ˆå»ºç«‹
});
```

#### C. parent_id è½‰æ›
```typescript
let finalParentId: string | undefined = undefined;
if (item.parent_id && idMapping.has(item.parent_id)) {
  finalParentId = idMapping.get(item.parent_id);
}
```

#### D. å»ºç«‹ä»»å‹™ä¸¦è¨˜éŒ„æ˜ å°„
```typescript
const itemRes = await storage.createItem({
  ...
  parent_id: finalParentId,
  meta: {
    level: item.meta?.level || 1,
    original_order: item.meta?.order,
    wbs_code: finalWbsCode,
    ...
  }
});

if (!itemRes.error && itemRes.data && item.id) {
  idMapping.set(item.id, itemRes.data.id);
}
```

### 3. AI Prompt å·²å®šç¾©

**ä½ç½®**ï¼š`/src/lib/ai/prompts.ts` â†’ `WBS_PARSER_PROMPT`

AI å·²è¢«è¦æ±‚è¼¸å‡ºï¼š
- `id`: è‡¨æ™‚ IDï¼ˆä¾›æ˜ å°„ä½¿ç”¨ï¼‰
- `parent_id`: çˆ¶ä»»å‹™çš„è‡¨æ™‚ ID
- `level`: å±¤ç´šï¼ˆ1, 2, 3...ï¼‰
- `order`: åŒå±¤ç´šå…§çš„æ’åº

## ğŸ“‹ ä½¿ç”¨ç¯„ä¾‹

### è¼¸å…¥ï¼šä¸Šå‚³ WBS åœ–ç‰‡

```
1. å°ˆæ¡ˆå•Ÿå‹•
  1.1 éœ€æ±‚è¨ªè«‡
  1.2 ç¯„åœç¢ºèª
2. è¨­è¨ˆéšæ®µ
  2.1 UI è¨­è¨ˆ
    2.1.1 ç·šæ¡†åœ–
    2.1.2 è¦–è¦ºè¨­è¨ˆ
```

### è¼¸å‡ºï¼šå»ºç«‹çš„ä»»å‹™çµæ§‹

```
âœ… ä»»å‹™ 1: "å°ˆæ¡ˆå•Ÿå‹•" (level: 1, parent_id: null)
  âœ… ä»»å‹™ 2: "éœ€æ±‚è¨ªè«‡" (level: 2, parent_id: ä»»å‹™1çš„ID)
  âœ… ä»»å‹™ 3: "ç¯„åœç¢ºèª" (level: 2, parent_id: ä»»å‹™1çš„ID)
âœ… ä»»å‹™ 4: "è¨­è¨ˆéšæ®µ" (level: 1, parent_id: null)
  âœ… ä»»å‹™ 5: "UI è¨­è¨ˆ" (level: 2, parent_id: ä»»å‹™4çš„ID)
    âœ… ä»»å‹™ 6: "ç·šæ¡†åœ–" (level: 3, parent_id: ä»»å‹™5çš„ID)
    âœ… ä»»å‹™ 7: "è¦–è¦ºè¨­è¨ˆ" (level: 3, parent_id: ä»»å‹™5çš„ID)
```

## ğŸ”„ å·¥ä½œæµç¨‹

1. **ä½¿ç”¨è€…ä¸Šå‚³ WBS æ–‡ä»¶**
2. **AI è§£æä¸¦è¿”å›ä»»å‹™åˆ—è¡¨**ï¼ˆåŒ…å« id, parent_id, levelï¼‰
3. **ç³»çµ±æŒ‰ level æ’åº**ï¼ˆç¢ºä¿çˆ¶ä»»å‹™å…ˆå»ºç«‹ï¼‰
4. **å¾ªåºå»ºç«‹ä»»å‹™**ï¼š
   - å»ºç«‹ä»»å‹™æ™‚ï¼Œå°‡ AI çš„ parent_id è½‰æ›ç‚ºå¯¦éš› DB ID
   - å„²å­˜ level åˆ° meta
   - è¨˜éŒ„ ID æ˜ å°„é—œä¿‚
5. **æ‰€æœ‰ä»»å‹™é€²å…¥æ”¶ä»¶åŒ£**ï¼ˆä¿ç•™å±¤ç´šçµæ§‹ï¼‰
6. **ä½¿ç”¨è€…ç¢ºèªå¾Œå…¥åº«**

## âœ… é©—æ”¶æ¨™æº–

- [x] å¾ WBS æ–‡ä»¶è­˜åˆ¥å±¤ç´šçµæ§‹
- [x] æ­£ç¢ºè¨­å®š parent_id
- [x] æ­£ç¢ºå„²å­˜ level åˆ° meta
- [x] çˆ¶ä»»å‹™åœ¨å­ä»»å‹™ä¹‹å‰å»ºç«‹
- [x] ID æ˜ å°„æ­£ç¢ºè½‰æ›
- [x] WBS ç·¨è™Ÿè‡ªå‹•æå–ï¼ˆä¾‹å¦‚ "1.1"ï¼‰

## ğŸ“Š æ•ˆèƒ½è€ƒé‡

### ç›®å‰å¯¦ä½œ
- **æ–¹å¼**ï¼šå¾ªåºå»ºç«‹ï¼ˆSequential Creationï¼‰
- **å„ªé»**ï¼šé‚è¼¯ç°¡å–®ï¼Œç¢ºä¿çˆ¶ä»»å‹™ ID å¯ç”¨
- **ç¼ºé»**ï¼šå¤§é‡ä»»å‹™æ™‚é€Ÿåº¦è¼ƒæ…¢ï¼ˆä¾‹å¦‚ 50 å€‹ä»»å‹™ç´„éœ€ 10-15 ç§’ï¼‰

### æœªä¾†å„ªåŒ–ï¼ˆV2.0ï¼‰
- **æ–¹å¼**ï¼šæ‰¹æ¬¡å»ºç«‹ + äº‹å¾Œé—œè¯
- **é æœŸæ•ˆèƒ½**ï¼šæå‡ 3-5 å€
- **å¯¦ä½œæ™‚æ©Ÿ**ï¼šç•¶ä½¿ç”¨è€…åæ˜ é€Ÿåº¦å•é¡Œæ™‚

## ğŸ“š ç›¸é—œæ–‡ä»¶

1. **è¦åŠƒæ–‡ä»¶**ï¼š`/docs/plan/WBS_Hierarchy_Feature.md`
2. **æ¥­å‹™è¦å‰‡**ï¼š`/docs/spac/rules.md` - ç¬¬ 4.2 ç¯€
3. **å¯¦ä½œç¨‹å¼ç¢¼**ï¼š`/src/app/dashboard/DashboardPage.tsx` - Line 376-430
4. **AI Prompt**ï¼š`/src/lib/ai/prompts.ts` - `WBS_PARSER_PROMPT`

## ğŸš€ å¾ŒçºŒæ”¹é€²å»ºè­°

### Phase 1ï¼šUI é¡¯ç¤ºï¼ˆé«˜å„ªå…ˆï¼‰
- [ ] æ”¶ä»¶åŒ£ä¸­é¡¯ç¤ºå±¤ç´šç¸®æ’
- [ ] é¡¯ç¤ºçˆ¶ä»»å‹™é—œè¯æç¤º
- [ ] WBS ç·¨è™Ÿ badge

### Phase 2ï¼šäº’å‹•åŠŸèƒ½ï¼ˆä¸­å„ªå…ˆï¼‰
- [ ] ä»»å‹™æ¸…å–®æ”¯æ´æ¨¹ç‹€çµæ§‹é¡¯ç¤º
- [ ] å¯æ‘ºç–Š/å±•é–‹å­ä»»å‹™
- [ ] æ‹–æ›³èª¿æ•´å±¤ç´š

### Phase 3ï¼šæ•ˆèƒ½å„ªåŒ–ï¼ˆä½å„ªå…ˆï¼‰
- [ ] æ‰¹æ¬¡å»ºç«‹ä»»å‹™
- [ ] è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–ï¼ˆRecursive CTEï¼‰
- [ ] å¢åŠ  `path` æ¬„ä½åŠ é€ŸæŸ¥è©¢

## ğŸ‰ æˆæœ

ä½¿ç”¨è€…ç¾åœ¨å¯ä»¥ï¼š
- âœ… ä¸Šå‚³ WBS æ–‡ä»¶
- âœ… è‡ªå‹•è­˜åˆ¥å±¤ç´šçµæ§‹
- âœ… ä¸€éµå»ºç«‹å…·æœ‰æ­£ç¢ºçˆ¶å­é—œä¿‚çš„ä»»å‹™
- âœ… ç„¡éœ€æ‰‹å‹•èª¿æ•´å±¤ç´š
- âœ… ç¯€çœå¤§é‡æ™‚é–“

---

**å¯¦ä½œç‹€æ…‹**ï¼šâœ… å®Œæˆä¸¦æ¸¬è©¦  
**é è¨ˆå½±éŸ¿**ï¼šå¤§å¹…æå‡ WBS å°å…¥æ•ˆç‡ï¼Œæ¸›å°‘ 80% ä»¥ä¸Šçš„æ‰‹å‹•èª¿æ•´æ™‚é–“
